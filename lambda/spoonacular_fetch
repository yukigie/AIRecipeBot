import json
import requests
import boto3
import datetime

def lambda_handler(event, context):
    # Parse body from event (for proxy integration)
    body = json.loads(event['body'])
    ingredients = body.get('ingredients', 'chicken,tomato')

    # Spoonacular call
    api_key = "3256ce24cd2b4a0bb8c7de40489e721e"
    url = f"https://api.spoonacular.com/recipes/findByIngredients?ingredients={ingredients}&number=1&apiKey={api_key}"
    response = requests.get(url)
    data = response.json()
    
    # Save to S3
    s3 = boto3.client('s3')
    bucket = 'ai-recipe-bucket1'
    file_name = f"api_results/{datetime.datetime.now().isoformat()}.json"
    s3.put_object(Bucket=bucket, Key=file_name, Body=json.dumps(data))
    
    return {
        'statusCode': 200,
        'headers': {
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': '*',
            'Access-Control-Allow-Methods': '*'
        },
        'body': json.dumps(data)
    }
